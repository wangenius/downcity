---
title: Volume 类
description: 向量数据存储和搜索类，提供文本向量化、批量处理和相似性搜索功能
---

# Volume 类

Volume 类是 DownCity 中负责具体向量数据操作的核心组件。它提供了文本向量化、批量处理、相似性搜索等功能，是与向量数据直接交互的主要接口。

## 基本概念

- **向量化 (Embedding)**: 将文本转换为数学向量表示
- **元数据 (Metadata)**: 附加到向量数据的结构化信息，用于过滤和分类
- **相似性搜索**: 基于向量距离查找语义相似的内容
- **批量处理**: 一次性处理多个文本项目以提高效率

## 快速开始

```typescript
import { Codex } from "@downcity/codex";
import { openai } from "ai";

// 创建 Codex 实例并获取 Volume
const codex = await Codex.create({
  model: openai.embedding("text-embedding-3-small"),
});
const volume = await codex.volume("documents");

// 存储单个文档
const docId = await volume.embedding(
  "人工智能是计算机科学的一个分支，致力于创建能够执行通常需要人类智能的任务的系统。",
  {
    type: "knowledge",
    category: "AI",
    language: "zh",
    source: "textbook",
  }
);

// 批量存储文档
const items = [
  {
    content: "机器学习是人工智能的一个子领域。",
    metadata: { type: "knowledge", category: "ML" },
  },
  {
    content: "深度学习使用神经网络进行学习。",
    metadata: { type: "knowledge", category: "DL" },
  },
];
const ids = await volume.batchEmbedding(items);

// 搜索相关内容
const results = await volume.search("什么是机器学习？", {
  limit: 3,
  where: { type: "knowledge" },
  distanceThreshold: 0.8,
});

console.log("搜索结果:", results);
```

## API 参考

### 单个文本向量化

#### `embedding(content: string, metadata?: Record<string, any>): Promise<string>`

将文本内容转换为向量并存储到数据库中。

**参数:**

- `content` (string): 要向量化的文本内容
- `metadata` (`Record<string, any>`, 可选): 附加的元数据信息

**返回:** `Promise<string>` - 生成的唯一 ID

**示例:**

```typescript
// 基本用法
const id1 = await volume.embedding("这是一段文本内容");

// 带元数据
const id2 = await volume.embedding("产品使用说明书的第一章节", {
  type: "manual",
  product: "smartphone",
  chapter: 1,
  version: "2.0",
  tags: ["setup", "getting-started"],
});

// 嵌套元数据
const id3 = await volume.embedding("用户反馈信息", {
  type: "feedback",
  user: {
    id: "user123",
    level: "premium",
  },
  rating: 5,
  timestamp: new Date().toISOString(),
});
```

### 批量向量化

#### `batchEmbedding(items: BatchEmbeddingItem[]): Promise<string[]>`

批量处理多个文本项目，提高处理效率。

**参数:**

- `items` (BatchEmbeddingItem[]): 批量处理项目列表


**返回:** `Promise<string[]>` - 生成的 ID 列表

**BatchEmbeddingItem 接口:**

```typescript
interface BatchEmbeddingItem {
  content: string; // 文本内容
  metadata?: Record<string, any>; // 元数据
  id?: string; // 可选的自定义 ID
}
```

**示例:**

```typescript
const documents = [
  {
    content: "第一章：产品介绍",
    metadata: { type: "manual", chapter: 1 },
  },
  {
    content: "第二章：安装指南",
    metadata: { type: "manual", chapter: 2 },
  },
  {
    id: "custom-id-001",
    content: "第三章：使用方法",
    metadata: { type: "manual", chapter: 3 },
  },
];

const ids = await volume.batchEmbedding(documents);
console.log("批量处理完成，生成的 IDs:", ids);
```

### 相似性搜索

#### `search(query: string, options?: SearchOptions): Promise<SearchResult[]>`

根据查询文本进行向量相似性搜索。

**参数:**

- `query` (string): 查询文本
- `options` (SearchOptions, 可选): 搜索选项

**返回:** `Promise<SearchResult[]>` - 搜索结果列表

**SearchOptions 接口:**

```typescript
interface SearchOptions {
  limit?: number; // 返回结果数量，默认 5
  where?: Record<string, any>; // 元数据过滤条件
  select?: string[]; // 要返回的列
  includeVector?: boolean; // 是否包含向量数据，默认 false
  distanceThreshold?: number; // 距离阈值过滤
}
```

**SearchResult 接口:**

```typescript
interface SearchResult {
  id: string; // 文档 ID
  content: string; // 文档内容
  metadata: Record<string, any>; // 元数据
  distance: number; // 相似度距离（越小越相似）
  vector?: number[]; // 向量数据（可选）
}
```

**基本搜索示例:**

```typescript
// 简单搜索
const results = await volume.search("如何安装产品？");

// 限制结果数量
const topResults = await volume.search("产品特性", { limit: 3 });

// 带元数据过滤
const manualResults = await volume.search("使用方法", {
  limit: 5,
  where: { type: "manual" },
});

// 距离阈值过滤
const preciseResults = await volume.search("技术规格", {
  distanceThreshold: 0.7, // 只返回相似度高的结果
});
```

**高级搜索示例:**

```typescript
// 复杂过滤条件
const advancedResults = await volume.search("故障排除", {
  limit: 10,
  where: {
    type: "manual",
    chapter: { $gte: 5 }, // 章节号 >= 5
    tags: ["troubleshooting"], // 包含特定标签
    "user.level": "premium", // 嵌套属性过滤
  },
  select: ["id", "content", "metadata"], // 只返回指定列
  includeVector: false, // 不包含向量数据
  distanceThreshold: 0.8,
});

// 多值过滤（IN 操作）
const categoryResults = await volume.search("产品信息", {
  where: {
    category: ["electronics", "software", "hardware"], // 匹配多个类别
  },
});

// 范围查询
const recentResults = await volume.search("最新更新", {
  where: {
    timestamp: {
      $gte: "2024-01-01",
      $lt: "2024-12-31",
    },
    rating: { $gt: 3 }, // 评分 > 3
  },
});
```

## 元数据过滤操作符

Volume 支持丰富的元数据过滤操作符：

| 操作符  | 说明     | 示例                             |
| ------- | -------- | -------------------------------- |
| `$gt`   | 大于     | `{ score: { $gt: 80 } }`         |
| `$gte`  | 大于等于 | `{ age: { $gte: 18 } }`          |
| `$lt`   | 小于     | `{ price: { $lt: 100 } }`        |
| `$lte`  | 小于等于 | `{ rating: { $lte: 5 } }`        |
| `$ne`   | 不等于   | `{ status: { $ne: 'deleted' } }` |
| `Array` | IN 操作  | `{ category: ['A', 'B', 'C'] }`  |
| `null`  | 空值检查 | `{ optional_field: null }`       |

## 元数据设计最佳实践

### 1. 扁平化处理

Volume 自动处理嵌套元数据的扁平化：

```typescript
// 输入的嵌套元数据
const metadata = {
  user: {
    id: "user123",
    profile: {
      level: "premium",
      region: "asia",
    },
  },
  tags: ["important", "urgent"],
};

// 内部自动扁平化为
// {
//   'user.id': 'user123',
//   'user.profile.level': 'premium',
//   'user.profile.region': 'asia',
//   'tags': ['important', 'urgent']
// }

// 搜索时可以使用点分隔的键名
const results = await volume.search("查询内容", {
  where: {
    "user.profile.level": "premium",
    "user.profile.region": "asia",
  },
});
```

### 2. 元数据结构建议

```typescript
// 推荐的元数据结构
const recommendedMetadata = {
  // 基本分类
  type: "document", // 数据类型
  category: "manual", // 类别
  subcategory: "installation", // 子类别

  // 内容属性
  language: "zh", // 语言
  format: "text", // 格式
  length: 1500, // 长度

  // 来源信息
  source: {
    system: "cms",
    id: "doc-123",
    url: "https://example.com/doc/123",
  },

  // 时间信息
  created_at: "2024-01-15T10:30:00Z",
  updated_at: "2024-01-20T15:45:00Z",

  // 权限和可见性
  visibility: "public",
  access_level: "basic",

  // 标签和分类
  tags: ["setup", "beginner", "important"],
  keywords: ["installation", "configuration"],

  // 质量和评分
  quality_score: 0.95,
  user_rating: 4.5,

  // 自定义业务字段
  business: {
    department: "support",
    priority: "high",
    version: "2.1.0",
  },
};
```

## 性能优化建议

### 1. 批量操作

```typescript
// ❌ 低效：逐个处理
for (const doc of documents) {
  await volume.embedding(doc.content, doc.metadata);
}

// ✅ 高效：批量处理
const items = documents.map((doc) => ({
  content: doc.content,
  metadata: doc.metadata,
}));
const ids = await volume.batchEmbedding(items);
```

### 2. 合理使用过滤条件

```typescript
// ❌ 低效：获取所有结果后过滤
const allResults = await volume.search("查询", { limit: 1000 });
const filtered = allResults.filter((r) => r.metadata.type === "manual");

// ✅ 高效：在数据库层面过滤
const results = await volume.search("查询", {
  limit: 10,
  where: { type: "manual" },
});
```

### 3. 选择性返回字段

```typescript
// ❌ 返回所有字段（包含大量数据）
const results = await volume.search("查询");

// ✅ 只返回需要的字段
const results = await volume.search("查询", {
  select: ["id", "content"],
  includeVector: false, // 不返回向量数据
});
```

## 错误处理

```typescript
import { CodexError } from "@downcity/codex";

try {
  const results = await volume.search("查询内容");
  // 处理结果...
} catch (error) {
  if (error instanceof CodexError) {
    switch (error.id) {
      case "INVALID_ARGS":
        console.error("参数错误:", error.message);
        break;
      case "VOLUME_SEARCH_FAILED":
        console.error("搜索失败:", error.message);
        break;
      default:
        console.error("Codex 错误:", error.message);
    }
  } else {
    console.error("未知错误:", error);
  }
}
```

## 类型定义

### BatchEmbeddingItem

```typescript
interface BatchEmbeddingItem {
  content: string;
  metadata?: Record<string, any>;
  id?: string;
}
```

### SearchOptions

```typescript
interface SearchOptions {
  limit?: number;
  where?: Record<string, any>;
  select?: string[];
  includeVector?: boolean;
  distanceThreshold?: number;
}
```

### SearchResult

```typescript
interface SearchResult {
  id: string;
  content: string;
  metadata: Record<string, any>;
  distance: number;
  vector?: number[];
}
```

## 下一步

- 了解 [Codex 类](./codex) 的数据库管理功能
- 查看 [错误处理](./error) 完整指南
- 探索 [实际应用案例](./examples) 和最佳实践
